"use strict";(self.webpackChunksd_webui_3d_editor=self.webpackChunksd_webui_3d_editor||[]).push([[398],{2398:function(t,e,r){r.r(e),r.d(e,{ThreeMFLoader:function(){return l}});var n=r(9477),o=r(8646);const s=n.KI_;class l extends n.aNw{constructor(t){super(t),this.availableExtensions=[]}load(t,e,r,o){const s=this,l=new n.hH6(s.manager);l.setPath(s.path),l.setResponseType("arraybuffer"),l.setRequestHeader(s.requestHeader),l.setWithCredentials(s.withCredentials),l.load(t,(function(r){try{e(s.parse(r))}catch(e){o?o(e):console.error(e),s.manager.itemError(t)}}),r,o)}parse(t){const e=this,r=new n.dpR(this.manager);function l(t){const e=[],r=(new DOMParser).parseFromString(t,"application/xml").querySelectorAll("Relationship");for(let t=0;t<r.length;t++){const n=r[t],o={target:n.getAttribute("Target"),id:n.getAttribute("Id"),type:n.getAttribute("Type")};e.push(o)}return e}function i(t){const e={id:t.getAttribute("id"),basematerials:[]},r=t.querySelectorAll("base");for(let t=0;t<r.length;t++){const n=p(r[t]);n.index=t,e.basematerials.push(n)}return e}function u(t){const e={id:t.getAttribute("id"),texid:t.getAttribute("texid"),displaypropertiesid:t.getAttribute("displaypropertiesid")},r=t.querySelectorAll("tex2coord"),n=[];for(let t=0;t<r.length;t++){const e=r[t],o=e.getAttribute("u"),s=e.getAttribute("v");n.push(parseFloat(o),parseFloat(s))}return e.uvs=new Float32Array(n),e}function c(t){const e={id:t.getAttribute("id"),displaypropertiesid:t.getAttribute("displaypropertiesid")},r=t.querySelectorAll("color"),o=[],l=new n.Ilk;for(let t=0;t<r.length;t++){const e=r[t].getAttribute("color");l.setStyle(e.substring(0,7),s),o.push(l.r,l.g,l.b)}return e.colors=new Float32Array(o),e}function a(t){const e={id:t.getAttribute("id")},r=t.querySelectorAll("pbmetallic"),n=[];for(let t=0;t<r.length;t++){const e=r[t];n.push({name:e.getAttribute("name"),metallicness:parseFloat(e.getAttribute("metallicness")),roughness:parseFloat(e.getAttribute("roughness"))})}return e.data=n,e}function p(t){const e={};return e.name=t.getAttribute("name"),e.displaycolor=t.getAttribute("displaycolor"),e.displaypropertiesid=t.getAttribute("displaypropertiesid"),e}function d(t){const e={};e.objectId=t.getAttribute("objectid");const r=t.getAttribute("transform");return r&&(e.transform=h(r)),e}function h(t){const e=[];t.split(" ").forEach((function(t){e.push(parseFloat(t))}));const r=new n.yGw;return r.set(e[0],e[3],e[6],e[9],e[1],e[4],e[7],e[10],e[2],e[5],e[8],e[11],0,0,0,1),r}function g(t){const e={type:t.getAttribute("type")},r=t.getAttribute("id");r&&(e.id=r);const n=t.getAttribute("pid");n&&(e.pid=n);const o=t.getAttribute("pindex");o&&(e.pindex=o);const s=t.getAttribute("thumbnail");s&&(e.thumbnail=s);const l=t.getAttribute("partnumber");l&&(e.partnumber=l);const i=t.getAttribute("name");i&&(e.name=i);const u=t.querySelector("mesh");u&&(e.mesh=function(t){const e={},r=[],n=t.querySelectorAll("vertices vertex");for(let t=0;t<n.length;t++){const e=n[t],o=e.getAttribute("x"),s=e.getAttribute("y"),l=e.getAttribute("z");r.push(parseFloat(o),parseFloat(s),parseFloat(l))}e.vertices=new Float32Array(r);const o=[],s=[],l=t.querySelectorAll("triangles triangle");for(let t=0;t<l.length;t++){const e=l[t],r=e.getAttribute("v1"),n=e.getAttribute("v2"),i=e.getAttribute("v3"),u=e.getAttribute("p1"),c=e.getAttribute("p2"),a=e.getAttribute("p3"),p=e.getAttribute("pid"),d={};d.v1=parseInt(r,10),d.v2=parseInt(n,10),d.v3=parseInt(i,10),s.push(d.v1,d.v2,d.v3),u&&(d.p1=parseInt(u,10)),c&&(d.p2=parseInt(c,10)),a&&(d.p3=parseInt(a,10)),p&&(d.pid=p),0<Object.keys(d).length&&o.push(d)}return e.triangleProperties=o,e.triangles=new Uint32Array(s),e}(u));const c=t.querySelector("components");return c&&(e.components=function(t){const e=[],r=t.querySelectorAll("component");for(let t=0;t<r.length;t++){const n=d(r[t]);e.push(n)}return e}(c)),e}function b(t){const e={unit:t.getAttribute("unit")||"millimeter"},r=t.querySelectorAll("metadata");r&&(e.metadata=function(t){const e={};for(let r=0;r<t.length;r++){const n=t[r],o=n.getAttribute("name");0<=["Title","Designer","Description","Copyright","LicenseTerms","Rating","CreationDate","ModificationDate"].indexOf(o)&&(e[o]=n.textContent)}return e}(r));const n=t.querySelector("resources");n&&(e.resources=function(t){const e={basematerials:{}},r=t.querySelectorAll("basematerials");for(let t=0;t<r.length;t++){const n=i(r[t]);e.basematerials[n.id]=n}e.texture2d={};const n=t.querySelectorAll("texture2d");for(let t=0;t<n.length;t++){const r={id:(o=n[t]).getAttribute("id"),path:o.getAttribute("path"),contenttype:o.getAttribute("contenttype"),tilestyleu:o.getAttribute("tilestyleu"),tilestylev:o.getAttribute("tilestylev"),filter:o.getAttribute("filter")};e.texture2d[r.id]=r}var o;e.colorgroup={};const s=t.querySelectorAll("colorgroup");for(let t=0;t<s.length;t++){const r=c(s[t]);e.colorgroup[r.id]=r}e.pbmetallicdisplayproperties={};const l=t.querySelectorAll("pbmetallicdisplayproperties");for(let t=0;t<l.length;t++){const r=a(l[t]);e.pbmetallicdisplayproperties[r.id]=r}e.texture2dgroup={};const p=t.querySelectorAll("texture2dgroup");for(let t=0;t<p.length;t++){const r=u(p[t]);e.texture2dgroup[r.id]=r}e.object={};const d=t.querySelectorAll("object");for(let t=0;t<d.length;t++){const r=g(d[t]);e.object[r.id]=r}return e}(n));const o=t.querySelector("build");return o&&(e.build=function(t){const e=[],r=t.querySelectorAll("item");for(let t=0;t<r.length;t++){const n=r[t],o={objectId:n.getAttribute("objectid")},s=n.getAttribute("transform");s&&(o.transform=h(s)),e.push(o)}return e}(o)),e}function f(t,e,o,l){const i=t.texid,u=o.resources.texture2d[i];if(u){const t=l[u.path],e=u.contenttype,o=new Blob([t],{type:e}),i=URL.createObjectURL(o),c=r.load(i,(function(){URL.revokeObjectURL(i)}));switch(c.colorSpace=s,u.tilestyleu){case"wrap":default:c.wrapS=n.rpg;break;case"mirror":c.wrapS=n.OoA;break;case"none":case"clamp":c.wrapS=n.uWy}switch(u.tilestylev){case"wrap":default:c.wrapT=n.rpg;break;case"mirror":c.wrapT=n.OoA;break;case"none":case"clamp":c.wrapT=n.uWy}switch(u.filter){case"auto":default:c.magFilter=n.wem,c.minFilter=n.D1R;break;case"linear":c.magFilter=n.wem,c.minFilter=n.wem;break;case"nearest":c.magFilter=n.TyD,c.minFilter=n.TyD}return c}return null}function m(t,e,r,o,s,l,i){const u=i.pindex,c={};for(let t=0,r=e.length;t<r;t++){const r=e[t],n=void 0!==r.p1?r.p1:u;void 0===c[n]&&(c[n]=[]),c[n].push(r)}const a=Object.keys(c),p=[];for(let e=0,u=a.length;e<u;e++){const u=a[e],d=c[u],h=S(t.basematerials[u],o,s,l,i,j),g=new n.u9r,b=[],f=r.vertices;for(let t=0,e=d.length;t<e;t++){const e=d[t];b.push(f[3*e.v1+0]),b.push(f[3*e.v1+1]),b.push(f[3*e.v1+2]),b.push(f[3*e.v2+0]),b.push(f[3*e.v2+1]),b.push(f[3*e.v2+2]),b.push(f[3*e.v3+0]),b.push(f[3*e.v3+1]),b.push(f[3*e.v3+2])}g.setAttribute("position",new n.a$l(b,3));const m=new n.Kj0(g,h);p.push(m)}return p}function A(t,e,r,o,s,l,i){const u=new n.u9r,c=[],a=[],p=r.vertices,d=t.uvs;for(let t=0,r=e.length;t<r;t++){const r=e[t];c.push(p[3*r.v1+0]),c.push(p[3*r.v1+1]),c.push(p[3*r.v1+2]),c.push(p[3*r.v2+0]),c.push(p[3*r.v2+1]),c.push(p[3*r.v2+2]),c.push(p[3*r.v3+0]),c.push(p[3*r.v3+1]),c.push(p[3*r.v3+2]),a.push(d[2*r.p1+0]),a.push(d[2*r.p1+1]),a.push(d[2*r.p2+0]),a.push(d[2*r.p2+1]),a.push(d[2*r.p3+0]),a.push(d[2*r.p3+1])}u.setAttribute("position",new n.a$l(c,3)),u.setAttribute("uv",new n.a$l(a,2));const h=S(t,o,s,l,i,f),g=new n.xoR({map:h,flatShading:!0});return new n.Kj0(u,g)}function y(t,e,r,o){const s=new n.u9r,l=[],i=[],u=r.vertices,c=t.colors;for(let t=0,r=e.length;t<r;t++){const r=e[t],n=r.v1,s=r.v2,a=r.v3;l.push(u[3*n+0]),l.push(u[3*n+1]),l.push(u[3*n+2]),l.push(u[3*s+0]),l.push(u[3*s+1]),l.push(u[3*s+2]),l.push(u[3*a+0]),l.push(u[3*a+1]),l.push(u[3*a+2]);const p=void 0!==r.p1?r.p1:o.pindex,d=void 0!==r.p2?r.p2:p,h=void 0!==r.p3?r.p3:p;i.push(c[3*p+0]),i.push(c[3*p+1]),i.push(c[3*p+2]),i.push(c[3*d+0]),i.push(c[3*d+1]),i.push(c[3*d+2]),i.push(c[3*h+0]),i.push(c[3*h+1]),i.push(c[3*h+2])}s.setAttribute("position",new n.a$l(l,3)),s.setAttribute("color",new n.a$l(i,3));const a=new n.xoR({vertexColors:!0,flatShading:!0});return new n.Kj0(s,a)}function v(t){const e=new n.u9r;e.setIndex(new n.TlE(t.triangles,1)),e.setAttribute("position",new n.TlE(t.vertices,3));const r=new n.xoR({color:16777215,flatShading:!0});return new n.Kj0(e,r)}function w(t,e){return void 0!==e.resources.texture2dgroup[t]?"texture":void 0!==e.resources.basematerials[t]?"material":void 0!==e.resources.colorgroup[t]?"vertexColors":"default"===t?"default":void 0}function x(t,e,r,o,s){const l=new n.ZAu,i=function(t,e){const r={},n=t.triangleProperties,o=e.pid;for(let t=0,e=n.length;t<e;t++){const e=n[t];let s=void 0!==e.pid?e.pid:o;void 0===s&&(s="default"),void 0===r[s]&&(r[s]=[]),r[s].push(e)}return r}(t,s),u=function(t,e,r,n,o,s){const l=Object.keys(t),i=[];for(let u=0,c=l.length;u<c;u++){const c=l[u],a=t[c];switch(w(c,n)){case"material":const t=m(n.resources.basematerials[c],a,e,r,n,o,s);for(let e=0,r=t.length;e<r;e++)i.push(t[e]);break;case"texture":const l=n.resources.texture2dgroup[c];i.push(A(l,a,e,r,n,o,s));break;case"vertexColors":const u=n.resources.colorgroup[c];i.push(y(u,a,e,s));break;case"default":i.push(v(e));break;default:console.error("THREE.3MFLoader: Unsupported resource type.")}}if(s.name)for(let t=0;t<i.length;t++)i[t].name=s.name;return i}(i,t,e,r,o,s);for(let t=0,e=u.length;t<e;t++)l.add(u[t]);return l}function S(t,e,r,n,o,s){return void 0!==t.build||(t.build=s(t,e,r,n,o)),t.build}function j(t,e,r){let o;const l=t.displaypropertiesid,i=r.resources.pbmetallicdisplayproperties;if(null!==l&&void 0!==i[l]){const e=i[l].data[t.index];o=new n.Wid({flatShading:!0,roughness:e.roughness,metalness:e.metallicness})}else o=new n.xoR({flatShading:!0});o.name=t.name;const u=t.displaycolor,c=u.substring(0,7);return o.color.setStyle(c,s),9===u.length&&(o.opacity=parseInt(u.charAt(7)+u.charAt(8),16)/255),o}function F(t,e,r,o){const s=new n.ZAu;for(let n=0;n<t.length;n++){const l=t[n];let i=e[l.objectId];void 0===i&&(k(l.objectId,e,r,o),i=e[l.objectId]);const u=i.clone(),c=l.transform;c&&u.applyMatrix4(c),s.add(u)}return s}function k(t,r,n,o){const s=n.resources.object[t];if(s.mesh){const t=s.mesh;!function(t,r,n){if(!t)return;const o=[],s=Object.keys(t);for(let t=0;t<s.length;t++){const r=s[t];for(let t=0;t<e.availableExtensions.length;t++){const n=e.availableExtensions[t];n.ns===r&&o.push(n)}}for(let e=0;e<o.length;e++){const s=o[e];s.apply(n,t[s.ns],r)}}(n.extensions,t,n.xml),r[s.id]=S(t,r,n,o,s,x)}else{const t=s.components;r[s.id]=S(t,r,n,o,s,F)}s.name&&(r[s.id].name=s.name)}const q=function(t){let e,r,n=null,s=null;const i=[],u=[];let c;const a={},p={},d=new TextDecoder;try{n=o.GZ(new Uint8Array(t))}catch(t){if(t instanceof ReferenceError)return console.error("THREE.3MFLoader: fflate missing and file is compressed."),null}for(s in n)s.match(/\_rels\/.rels$/)?e=s:s.match(/3D\/_rels\/.*\.model\.rels$/)?r=s:s.match(/^3D\/.*\.model$/)?i.push(s):s.match(/^3D\/Textures?\/.*/)&&u.push(s);const h=n[e],g=l(d.decode(h));if(r){const t=n[r];c=l(d.decode(t))}for(let t=0;t<i.length;t++){const e=i[t],r=n[e],o=d.decode(r),s=(new DOMParser).parseFromString(o,"application/xml");"model"!==s.documentElement.nodeName.toLowerCase()&&console.error("THREE.3MFLoader: Error loading 3MF - no 3MF document found: ",e);const l=s.querySelector("model"),u={};for(let t=0;t<l.attributes.length;t++){const e=l.attributes[t];e.name.match(/^xmlns:(.+)$/)&&(u[e.value]=RegExp.$1)}const c=b(l);c.xml=l,0<Object.keys(u).length&&(c.extensions=u),a[e]=c}for(let t=0;t<u.length;t++){const e=u[t];p[e]=n[e].buffer}return{rels:g,modelRels:c,model:a,printTicket:{},texture:p}}(t),R=function(t){const e=t.model,r=t.modelRels,n={},o=Object.keys(e),s={};if(r)for(let e=0,n=r.length;e<n;e++){const n=r[e],o=n.target.substring(1);t.texture[o]&&(s[n.target]=t.texture[o])}for(let t=0;t<o.length;t++){const r=e[o[t]],l=Object.keys(r.resources.object);for(let t=0;t<l.length;t++)k(l[t],n,r,s)}return n}(q);return function(t,e){const r=new n.ZAu,o=function(t){for(let e=0;e<t.length;e++){const r=t[e];if("model"===r.target.split(".").pop().toLowerCase())return r}}(e.rels),s=e.model[o.target.substring(1)].build;for(let e=0;e<s.length;e++){const n=s[e],o=t[n.objectId].clone(),l=n.transform;l&&o.applyMatrix4(l),r.add(o)}return r}(R,q)}addExtension(t){this.availableExtensions.push(t)}}}}]);